<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PoFlow</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <script src="https://cdn.plot.ly/plotly-2.6.3.min.js"></script>
    <script type="module">
      import { createApp, nextTick } from "https://unpkg.com/petite-vue?module";

      const GetEllipseCoordinates = Module.cwrap(
        "GetEllipseCoordinates",
        "string",
        ["number", "number"]
      );

      const GetNaca00XXCoordinates = Module.cwrap(
        "GetNaca00XXCoordinates",
        "string",
        ["number", "number"]
      );

      const GetCoords = (airfoiltype, ratio) => {
        let coords;
        const numPoints = 10;
        if (airfoiltype === "ellipse") {
          coords = GetEllipseCoordinates(numPoints, ratio);
        } else if (airfoiltype === "naca") {
          coords = GetEllipseCoordinates(numPoints, ratio);
        }
        console.log(coords);
        return coords;
      };

      function PlotComponent(props) {
        console.log(props);
        const airfoiltype = props.airfoiltype;
        const ratio = props.ratio;
        const coords = JSON.parse(GetCoords(airfoiltype, ratio));
        const trace1 = {
          x: coords.x,
          y: coords.y,
          mode: "markers",
          type: "scatter",
        };
        const data = [trace1];
        return {
          get getPlotData() {
            return data;
          },
          $template: "#plot-component-template",
          step: props.step,
          airfoiltype: props.airfoiltype,
          ratio: props.ratio,
          data: data,
        };
      }

      function FieldComponent(props) {
        return {
          $template: "#field-component-template",
          field: props.field,
          get isInvalid() {
            return props.isInvalid();
          },
          get invalidMessage() {
            return props.invalidMessage();
          },
          validate() {
            nextTick(() => {
              if (this.isInvalid) props.validate();
            });
          },
        };
      }

      function StepsIndicatorComponent(props) {
        return {
          $template: "#step-indicator-component-template",
          stepsCount: props.stepsCount,
          get stepsCountWithSuccessPage() {
            return this.stepsCount + 1;
          },
        };
      }
      createApp({
        PlotComponent,
        StepsIndicatorComponent,
        FieldComponent,
        currentStep: 0,
        submitted: false,
        invalids: {},

        fields: {
          airfoiltype: {
            id: "myInput",
            label: "Airfoil Type",
            value: "2:1 Ellipse",
            validations: [
              { message: "Name is a required field", test: (value) => value },
            ],
            isSelectList: true,
            validValues: {
              "2:1 Ellipse": { type: "ellipse", ratio: 0.5 },
              "NACA-0006": { type: "naca", ratio: 0.06 },
              "NACA-0008": { type: "naca", ratio: 0.08 },
            },
          },
          horizontalVelocity: {
            id: "",
            label: "Horizontal Velocity",
            value: "",
            validations: [],
          },
          verticalVelocity: {
            id: "",
            label: "Vertical Velocity",
            value: "",
            validations: [],
          },
        },

        steps: [["airfoiltype"], ["horizontalVelocity", "verticalVelocity"]],

        get GetAirFoilType() {
          const fieldValue = this.fields["airfoiltype"].value;
          const data = this.fields["airfoiltype"].validValues[fieldValue];
          if (data) {
            console.log("data", data.type);
            return data.type;
          }
        },

        get GetAirFoilRatio() {
          const fieldValue = this.fields["airfoiltype"].value;
          const data = this.fields["airfoiltype"].validValues[fieldValue];
          if (data) {
            console.log("data", data.ratio);
            return data.ratio;
          }
        },

        get currentFields() {
          return this.steps[this.currentStep];
        },
        get totalSteps() {
          return this.steps.length;
        },
        get isFirstStep() {
          return this.currentStep === 0;
        },
        get isLastStep() {
          return this.currentStep === this.totalSteps - 1;
        },

        // Methods
        previousStep() {
          console.log("you clicked previous");
          console.log("isFirstStep", this.isFirstStep);
          console.log("current step is", this.currentStep);
          if (this.isFirstStep) return;
          // removes all invalids so doesn't show error messages on back
          this.invalids = {};
          this.currentStep--;
          console.log("current step is", this.currentStep);
        },
        nextStep() {
          if (this.isLastStep) return;
          this.validate();
          if (this.isInvalid) return;
          this.currentStep++;
        },
        get isInvalid() {
          return !!Object.values(this.invalids).filter((key) => key).length;
        },
        validate() {
          this.invalids = {};
          // validates all the fields on the current page
          this.currentFields.forEach((key) => {
            this.validateField(key);
          });
        },
        validateField(fieldKey) {
          this.invalids[fieldKey] = false;
          const field = this.fields[fieldKey];
          // run through each of the fields validation tests
          field.validations.forEach((validation) => {
            if (!validation.test(field.value)) {
              this.invalids[fieldKey] = validation.message;
            }
          });
        },

        submit() {
          // if form not valid don't submit
          this.validate();
          if (this.isInvalid) return;
          // submit on valid form
          console.log("doing submit", this.fields);
          this.submitted = true;
        },
      }).mount("#multi-step-form");
    </script>
  </head>

  <body>
    <header>
      <h1>PoFlow</h1>
    </header>
    <div class="left-sidebar">Left Sidebar</div>
    <main>
      <div
        id="multi-step-form"
        class="hidden"
        v-scope
        @mounted="$el.classList.remove('hidden')"
      >
        <form class="p-10" @submit.prevent="">
          <div v-if="!submitted">
            <div v-for="(fieldKeys, step) in steps">
              <div v-if="currentStep === step">
                <div
                  v-for="(field, index) in fieldKeys"
                  v-scope="FieldComponent({
                          field: fields[field],
                          isInvalid:()=> !!invalids[field],
                          invalidMessage: () => invalids[field],
                          validate: ()=> validateField(field)
                        })"
                ></div>
              </div>
            </div>
            <div v-if="isFirstStep">
              <div>make the plot for step 0</div>
              <div
                v-scope="PlotComponent({step: currentStep, airfoiltype: GetAirFoilType, ratio: GetAirFoilRatio})"
              ></div>
            </div>
            <div v-else-if="currentStep === 1">make the plot for step 1</div>
            <div v-else-if="currentStep === 2">make the plot for step 2</div>
            <div v-else-if="currentStep === 3">make the plot for step 3</div>
            <footer class="flex flex-row-reverse gap-2 justify-start mt-5">
              <button v-if="isLastStep" class="btn btn-primary" @click="submit">
                Submit
              </button>
              <button
                v-if="!isLastStep"
                class="btn btn-primary"
                @click="nextStep"
              >
                Next
              </button>
              <button v-if="!isFirstStep" class="btn" @click="previousStep">
                Previous
              </button>
            </footer>
          </div>
          <div v-else>
            <h3 class="p-5 text-lg">Hey!, thanks for your submission!</h3>
          </div>
        </form>
      </div>
    </main>

    <template id="plot-component-template">
      {{data}}
      <script>
        Plotly.newPlot("myChart", getPlotData());
      </script>
    </template>

    <template id="step-indicator-component-template">
      <div class="flex items-stretch gap-2">
        <div
          v-for="step in stepsCountWithSuccessPage"
          class="h-2 w-full rounded text-purple-500"
          style="border: 1px solid"
          :class="{'bg-purple-500 ': step - 1 <= currentStep || submitted}"
        ></div>
      </div>
    </template>

    <template id="field-component-template">
      <div class="relative">
        <div class="form-control">
          <label class="label"> {{field.label}} </label>
          <div v-if="field.isSelectList">
            <select
              class="input input-bordered m-2 w-full"
              :class="{'input-error' : isInvalid}"
              @input="validate"
              :id="field.id"
              type="text"
              v-model="field.value"
            >
              <option v-for="(key, value) in field.validValues">
                {{value}}
              </option>
            </select>
          </div>
          <div v-else>
            <input
              class="input input-bordered m-2 w-full"
              type="text"
              v-model="field.value"
              :class="{'input-error' : isInvalid}"
              @input="validate"
              :id="field.id"
            />
          </div>
        </div>
        <div
          v-if="isInvalid"
          class="text-error text-right text-sm pr-5 absolute right-0"
          style="bottom: -7px"
        >
          {{invalidMessage}}
        </div>
      </div>
    </template>
  </body>
  <script async type="text/javascript" src="src/wasm/geometry.js"></script>
</html>
<style>
  body {
    display: grid;
    height: 100vh;
    grid-template: auto 1fr / auto 1fr;
  }

  header {
    padding: 2rem;
    grid-column: 1 / 4;
    border: 1px solid black;
  }

  .left-sidebar {
    grid-column: 1 / 2;
    border: 1px solid black;
  }

  main {
    grid-column: 2 / 3;
    border: 1px solid black;
  }

  footer {
    padding: 2rem;
    text-align: center;
    grid-column: 1 / 4;
    border: 1px solid black;
  }

  body {
    font-family: system-ui, sans-serif;
  }

  .left-sidebar,
  .right-sidebar {
    padding: 1rem;
  }

  body {
    font: 16px Arial;
  }

  input {
    border: 1px solid transparent;
    background-color: #f1f1f1;
    padding: 10px;
    font-size: 16px;
  }

  input[type="text"] {
    background-color: #f1f1f1;
    width: 25%;
  }

  input[type="submit"] {
    background-color: DodgerBlue;
    color: #fff;
  }

  form {
    /* Center the form on the page */
    margin: 0 auto;
    /* width: 500px; */
    /* Form outline */
    padding: 1em;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  form li + li {
    margin-top: 1em;
  }

  label {
    /* Uniform size & alignment */
    display: inline-block;
    width: 200px;
    text-align: right;
  }

  .button {
    padding-left: 200px;
  }

  button {
    margin-left: 0.5em;
  }

</style>
